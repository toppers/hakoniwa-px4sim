English ｜ [日本語](README-ja.md)

# Hakoniwa Installation Instructions

Navigate to the Hakoniwa directory:
```
cd hakoniwa-px4sim/hakoniwa
```

## For Windows

For Windows, please install the following tools:

* Visual Studio (C++)
  * Set the build mode to x64-Release
* [Python 3.12](https://www.python.org/)

## For WSL2

In the case of WSL2, work will be carried out inside a Docker container.

Please install the following beforehand:
```
sudo apt install docker.io
```
```
sudo apt install net-tools
```

After installation, start Docker:
```
sudo service docker start
```

Then, pull the Docker image with the following command:
```
bash docker/pull-image.bash
```

If you encounter the following error, please grant ownership to `/var/run/docker.sock`:
```
permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/images/create?fromImage=toppersjp%2Fhakoniwa-px4sim&tag=v1.0.1": dial unix /var/run/docker.sock: connect: permission denied
```

If successful, `toppersjp/hakoniwa-px4sim` will be created as shown below:
```
$ docker images
REPOSITORY                        TAG       IMAGE ID       CREATED             SIZE
toppersjp/hakoniwa-px4sim         v1.0.1    c34c696b8007   About an hour ago   3.98GB
```

Note that once the image is created, it will remain in Windows, so you only need to perform this step once.

Next, enter the Docker container with the following command:
```
bash docker/run.bash
```

## For Mac/Ubuntu

Please install the hakonwia core functions:

```
bash install.bash
```

If the installation is successful, you can check with the following command:

```
bash third-party/hakoniwa-core-cpp-client/hako-setup-check.bash
```

If successful, the following log will be output:

```
OK Directory exists: /usr/local/bin
OK Directory exists: /usr/local/bin/hakoniwa
OK Directory exists: /usr/local/lib
OK Directory exists: /usr/local/lib/hakoniwa
OK Directory exists: /etc/hakoniwa
OK Directory exists: /var/lib/hakoniwa
OK Directory exists: /var/lib/hakoniwa/mmap
OK File exists: /etc/hakoniwa/cpp_core_config.json
OK File exists: /usr/local/bin/hakoniwa/hako-cmd
OK File exists: /usr/local/lib/hakoniwa/libhakoarun.a
OK File exists: /usr/local/lib/hakoniwa/libshakoc.dylib
OK File exists: /usr/local/lib/hakoniwa/hakoc.so
OK File exists: /usr/local/lib/hakoniwa/libassets.dylib
OK File exists: /usr/local/lib/hakoniwa/libconductor.dylib
OK File exists: /usr/local/lib/hakoniwa/py
OK File exists: /usr/local/bin/hakoniwa/hako-proxy
Check complete.
```

# Hakoniwa Build Instructions（WSL2/Mac/Ubuntu）

Build the Hakoniwa environment. There are two build methods.

## If Not Using MATLAB Generated Code
```
bash build.bash
```

## If Using MATLAB Generated Code
```
bash build.bash HAKONIWA_MATLAB_BUILD=true
```

Upon success, a file named `cmake-build/src/hako-px4sim` will be created.

# Hakoniwa Build Instructions (Windows)

1. Launch Visual Studio and select "Open a local folder".
2. Choose hakoniwa-px4sim.
3. Select "Build" → "Build All" to start the build process.

# Aircraft Parameter Description

Aircraft parameters can be set in [drone_config.json](https://github.com/toppers/hakoniwa-px4sim/blob/main/hakoniwa/config/api_sample/drone_config_0.json).

The settings for each item are as follows:

## Simulation Settings
- **name**: The name of drone.
- **lockstep**: The lockstep mode of the simulation. Set to `true` for synchronous mode.
- **timeStep**: The time step interval of the simulation, in seconds (`s`). Example: `0.003`.
- **logOutputDirectory**: The path to the output directory for log files. Example: `"./"`.
- **logOutput**: Enables/disables log output for various sensors and MAVLink.
  - **sensors**: Log output settings for each sensor. `true` or `false`.
  - **mavlink**: Log output settings for MAVLink messages. `true` or `false`.
- **mavlink_tx_period_msec**: The transmission period for MAVLink messages, in milliseconds (`ms`).
- **location**: The geographical location of the simulation.
  - **latitude**: Latitude, in degrees (`deg`).
  - **longitude**: Longitude, in degrees (`deg`).
  - **altitude**: Altitude, in meters (`m`).
  - **magneticField**: The intensity and direction of the magnetic field.
    - **intensity_nT**: The intensity of the magnetic field, in nanoTesla (`nT`).
    - **declination_deg**: The magnetic declination, in degrees (`deg`).
    - **inclination_deg**: The magnetic inclination, in degrees (`deg`).

## Component Settings
- **droneDynamics**: The drone's dynamics model.
  - **physicsEquation**: Specifies the type of motion equation.
    - BodyFrame: Use this value for Hakoniwa's default physics model.
    - BodyFrameMatlab: Use this value when utilizing physics model code generated by MATLAB.
  - **collision_detection**: Set to `true` to detect collisions with obstacles and feedback to the physics equation; `false` to disable detection.
  - **enable_disturbance**: Set to `true` to affect disturbance to the physics/sensors; `false` to disable disturbance.
  - **manual_control**: Used when manually controlling the aircraft for sensor calibration. Set to `true` to enable external control. Usually, keep it `false`.
  - **airFrictionCoefficient**: The air resistance coefficient. Specify the first and second terms of air resistance in an array.
  - **inertia**: List of moments of inertia, in kilogram-meter squared (`kg*m^2`).
  - **mass_kg**: The mass of the drone, in kilograms (`kg`).
  - **body_size**: Specify the size of the aircraft (x, y, z) in an array, in meters (`m`).
  - **position_meter**: The initial position of the aircraft, in meters (`m`).
  - **angle_degree**: The initial angle of the aircraft, in degrees (`deg`).
- **rotor**: Rotor settings.
  - **vendor**: Specify the vendor name. Currently, set it to `None`.
  - **dynamics_constants**: Rotor dynamics constants.
    - **R**: Electrical resistance. Unit is Ohm (`Ω`).
    - **Cq**: Torque coefficient. Unit is (`Nms^2/rad^2`).
    - **D**: Dynamic viscosity friction coefficient. Unit is (`Nms/rad`).
    - **K**: Back electromotive force constant. Unit is radians/second-volt (`Nm/A`).
    - **J**: Motor inertia. Unit is kilogram-meter squared (`kg*m^2`).
- **thruster**: Thruster settings.
  - **vendor**: Specify the vendor name. Currently, set it to `None`.
  - **rotorPositions**: The positions and rotation directions of the rotors, in meters (`m`). rotationDirection is the direction of rotor rotation (CW:-1.0, CCW: 1.0)
  - **Ct**: Thrust coefficient. Unit is (`Ns^2/rad^2`).
- **sensors**: Settings for various sensors.
  - **sampleCount**: The number of samples.
  - **noise**: Noise level (standard deviation). If noise is not set, it is 0.

## Controller Settings

The **controller** section configures parameters related to the drone's flight controller module. The following parameters can be set:

- **moduleDirectory**: Specifies the directory path where the flight controller module is stored. For example, you would specify a path like `"../src/drone_control/cmake-build/workspace/FlightController"`.

- **moduleName**: Specifies the name of the flight controller module to be used. This determines which flight controller module will be utilized in the simulation. Example: `"FlightController"`.

- **direct_rotor_control**: Specifies whether direct rotor control is enabled. When set to `true`, direct control of the rotors is allowed. Typically, this is set to `false`.

- **mixer**: Configures the drone's mixer settings. If this section is not set, thrust and torque are directly input into the physical model.
  - **vendor**: Specifies the vendor name of the mixer. Currently, `"None"` and `"linear"` can be specified.
  - **enableDebugLog**: Specifies whether to enable debug logging. Setting this to `true` enables the debug log.
  - **enableErrorLog**: Specifies whether to enable error logging. Setting this to `true` enables the error log.

# Hakoniwa Command and Library Installation Instructions(WSL2/Mac/Ubuntu）

Hakoniwa includes a command (`hako-cmd`) and a shared library (`libshakoc.[so|dylib]`). These are used when running simulations without Unity.

Here are the installation instructions:

**Navigate to the directory:**

```
cd hakoniwa/third-party/hakoniwa-core-cpp-client
```

**Build:**

```
bash build.bash
```

**Install:**

```
bash install.bash
```

During installation, you may need to grant permissions to access /usr/local/lib/hakoniwa and /usr/local/bin/hakoniwa. Granting these permissions will place the Hakoniwa library and command in these directories.

**Setting Environment Variables:**

After successful installation, please set these paths in your environment variables.

For Ubuntu:

Add the following lines to your ~/.bashrc file.

```sh
export LD_LIBRARY_PATH=/usr/local/lib/hakoniwa:$LD_LIBRARY_PATH
export PATH=/usr/local/bin/hakoniwa:$PATH
```

To apply the changes, run the following command:

```sh
source ~/.bashrc
```

For macOS:

Depending on the shell you are using, add the following lines to either your ~/.bash_profile or ~/.zshrc.

```sh
export DYLD_LIBRARY_PATH=/usr/local/lib/hakoniwa:$DYLD_LIBRARY_PATH
export PATH=/usr/local/bin/hakoniwa:$PATH
```

To apply the changes, run the following command:

```sh
source ~/.bash_profile  # For Bash
source ~/.zshrc         # For Zsh
```

# Hakoniwa Command and Library Installation Instructions(Windows）

Open the Windows console, navigate to `hakoniwa-px4sim/hakoniwa/third-party/hakoniwa-core-cpp-client`, and execute the install command.

```
.\install.bat
```

Upon success, the following environment variables will be set:

* HAKO_CONFIG_PATH
  * <path/to>\hakoniwa-core-cpp-client\cpp_core_config.json
* PATH
  * <path/to>\hakoniwa-core-cpp-client\out\build\x64-Release\core\sample\base-procs\hako-cmd

If they are not set, please configure them manually.
